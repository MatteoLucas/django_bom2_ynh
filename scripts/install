#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

admin_email=$(ynh_user_get_info --username="$admin" --key=mail)

#=================================================
# COPY SOURCE FILES
#=================================================
cp -r ../bom "$data_dir/"

#=================================================
# SETTINGS
#=================================================
ynh_script_progression --message="Storing installation settings..."

log_file="$data_dir/django.log"
ynh_app_setting_set --app=$app --key=log_file --value="$log_file"

# Set default/fake keys
ynh_app_setting_set --app=$app --key=sendgrid_api_key --value="fake-sendgrid-key"
ynh_app_setting_set --app=$app --key=fixer_api_key --value="$fixer_api_key"

# Debug / log
ynh_app_setting_set --app=$app --key=debug_enabled --value="$debug_enabled"
ynh_app_setting_set --app=$app --key=log_level --value="$log_level"
ynh_app_setting_set --app=$app --key=default_from_email --value="$default_from_email"
ynh_app_setting_set --app=$app --key=admin_email --value="$admin_email"

# Redis
redis_db=$(ynh_redis_get_free_db)
ynh_app_setting_set --app=$app --key=redis_db --value="$redis_db"

#=================================================
# CHECK IF THE APP CAN BE INSTALLED WITH THESE ARGS
#=================================================
ynh_script_progression --message="Validating installation parameters..."
mkdir -p "$install_dir/media" "$install_dir/static"

#=================================================
# SETUP LOGGING
#=================================================
ynh_script_progression --message="Setup logging..."
myynh_setup_log_file
ynh_config_add_logrotate "$log_file"

#=================================================
# PYTHON VIRTUALENV
#=================================================
ynh_script_progression --message="Create and setup Python virtualenv..." --weight=45
cp ../conf/requirements.txt "$data_dir/requirements.txt"
myynh_setup_python_venv

#=================================================
# COPY CONFIG FILES
#=================================================
ynh_script_progression --message="Create $app configuration files..."

ynh_config_add --template="gunicorn.conf.py" --destination="$data_dir/gunicorn.conf.py"
ynh_config_add --template="manage.py" --destination="$data_dir/manage.py"
chmod +x "$data_dir/manage.py"
ynh_config_add --template="settings.py" --destination="$data_dir/settings.py"
ynh_config_add --template="setup_user.py" --destination="$data_dir/setup_user.py"
ynh_config_add --template="urls.py" --destination="$data_dir/urls.py"
ynh_config_add --template="wsgi.py" --destination="$data_dir/wsgi.py"

#=================================================
# MIGRATE / COLLECTSTATIC / CREATEADMIN
#=================================================
ynh_script_progression --message="migrate/collectstatic/createadmin..." --weight=10
cd "$data_dir" || exit

export DJANGO_LOGFILE_DIR="$data_dir"
export SENDGRID_API_KEY="fake-sendgrid-key"
export FIXER_ACCESS_KEY="$fixer_api_key"

"$data_dir/.venv/bin/python" manage.py migrate

"$data_dir/.venv/bin/python" manage.py shell <<EOF
from django.contrib.auth import get_user_model
User = get_user_model()
User.objects.update_or_create(
    username="$admin",
    defaults={"email": "$admin_email", "is_superuser": True, "is_staff": True}
)
EOF

"$data_dir/.venv/bin/python" manage.py check --deploy || true

#=================================================
# YUNOHOST INTEGRATION
#=================================================
ynh_script_progression --message="Integrating service in YunoHost..."
deactivate
yunohost service add --description $app $app

#=================================================
# FILE PERMISSIONS
#=================================================
ynh_script_progression --message="Set file permissions..."
myynh_fix_file_permissions

#=================================================
# SYSTEMD SERVICE
#=================================================
ynh_script_progression --message="Configuring systemd service '$app'..." --weight=5
ynh_config_add_systemd
ynh_systemctl --service=$app --action="start" --log_path="$log_file"

#=================================================
# NGINX CONFIGURATION
#=================================================
ynh_script_progression --message="Configuring nginx web server..."
ynh_config_add_nginx "public_path" "port"

#=================================================
# DONE
#=================================================
ynh_script_progression --message="Installation of $app completed" --last
